<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XanadiumAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { xanadium: { blue: '#3b82f6', glow: '#60a5fa' } },
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out forwards' },
                    keyframes: { fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } } }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #000000;
            background-image: radial-gradient(circle at 50% -20%, #172554 0%, #000000 70%);
            background-attachment: fixed;
            color: #e5e5e5;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #3b82f6; }
        
        .hidden-force { display: none !important; }
        
        /* Markdown Styles */
        .prose p { margin-bottom: 0.5em; line-height: 1.6; }
        .prose strong { color: #fff; font-weight: 600; }
        .prose code { background: #1e293b; padding: 2px 5px; border-radius: 4px; font-family: monospace; color: #60a5fa; font-size: 0.9em; border: 1px solid #1e3a8a; }
        .prose pre { background: #0f172a; padding: 10px; border-radius: 8px; overflow-x: auto; border: 1px solid #1e293b; margin-top: 8px; }
        
        .typing-cursor::after { content: 'â–‹'; display: inline-block; animation: blink 1s step-end infinite; color: #3b82f6; margin-left: 2px; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    </style>
</head>
<body class="h-screen flex overflow-hidden selection:bg-xanadium-blue selection:text-white">

    <!-- 1. SIDEBAR KIRI (Menu & History) -->
    <aside id="main-sidebar" class="fixed inset-y-0 left-0 w-72 bg-[#020617]/95 backdrop-blur-xl border-r border-blue-900/30 transform -translate-x-full transition-transform duration-300 z-50 flex flex-col shadow-2xl">
        <!-- Header Sidebar -->
        <div class="p-4 border-b border-blue-900/20 flex justify-between items-center">
            <div class="flex items-center gap-2 font-bold text-lg">
                <span class="text-xanadium-blue">Xanadium</span> AI
            </div>
            <button onclick="toggleSidebar()" class="text-gray-500 hover:text-white transition p-2"><i class="fa-solid fa-xmark text-lg"></i></button>
        </div>

        <!-- Tombol Chat Baru -->
        <div class="p-4 pb-2">
            <button onclick="createNewChat()" class="w-full bg-xanadium-blue/10 hover:bg-xanadium-blue/20 text-blue-400 hover:text-white border border-blue-500/20 px-4 py-3 rounded-xl transition flex items-center gap-3 text-sm font-medium">
                <i class="fa-solid fa-plus"></i> Chat Baru
            </button>
        </div>

        <!-- Label History -->
        <div class="px-4 py-2 text-[10px] uppercase tracking-widest text-gray-500 font-semibold mt-2">Riwayat Percakapan</div>

        <!-- List History (Auto Scrollable) -->
        <div id="history-list-container" class="flex-1 overflow-y-auto px-3 space-y-1 pb-4">
            <!-- Item history akan diisi otomatis via JS -->
            <p class="text-center text-gray-600 text-xs mt-10 italic">Belum ada riwayat.</p>
        </div>

        <!-- Footer Sidebar (User & Logout) -->
        <div class="p-4 border-t border-blue-900/20 bg-[#0f172a]/50">
            <div class="flex items-center gap-3 mb-4">
                <img src="{{ user_picture }}" onerror="this.src='https://ui-avatars.com/api/?name={{ user_name }}&background=3b82f6&color=fff'" class="w-9 h-9 rounded-full border border-blue-500/30">
                <div class="overflow-hidden">
                    <p class="text-sm font-semibold text-white truncate">{{ user_name }}</p>
                    <p class="text-[10px] text-gray-400 truncate">{{ user_email }}</p>
                </div>
            </div>
            <a href="/logout" class="block w-full text-center py-2 text-xs text-red-400 hover:text-red-300 hover:bg-red-500/10 rounded-lg transition border border-transparent hover:border-red-500/20">
                <i class="fa-solid fa-right-from-bracket mr-2"></i> Keluar Akun
            </a>
        </div>
    </aside>

    <!-- 2. MAIN CONTENT (Kanan) -->
    <div class="flex-1 flex flex-col h-full relative w-full transition-all duration-300">
        
        <!-- Navbar Atas -->
        <nav class="absolute top-0 w-full p-4 md:p-6 flex items-center z-30">
            <!-- Tombol Hamburger (Kiri) -->
            <button onclick="toggleSidebar()" class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-gray-300 hover:text-white transition backdrop-blur-md border border-white/5">
                <i class="fa-solid fa-bars text-lg"></i>
            </button>
            
            <!-- Brand Kecil (Tengah/Kanan saat chat aktif) -->
            <div id="brand-small" class="ml-4 opacity-0 transition-all duration-700 transform -translate-y-5 font-bold tracking-wide text-lg pointer-events-none">
                <span class="text-xanadium-blue drop-shadow-[0_0_15px_rgba(59,130,246,0.6)]">Xanadium</span> AI
            </div>
        </nav>

        <!-- AREA CHAT (Scrollable) -->
        <main class="flex-1 relative w-full max-w-4xl mx-auto h-full overflow-hidden flex flex-col">
            
            <!-- Welcome Screen -->
            <div id="welcome-screen" class="absolute inset-0 flex flex-col items-center justify-center transition-all duration-700 z-20 px-4">
                <div class="text-center space-y-4 animate-fade-in">
                    <h1 class="text-5xl md:text-8xl font-bold tracking-tight">
                        <span class="text-xanadium-blue drop-shadow-[0_0_30px_rgba(59,130,246,0.5)]">Xanadium</span> 
                        <span class="text-white drop-shadow-[0_0_15px_rgba(255,255,255,0.3)]">AI</span>
                    </h1>
                    <p class="text-blue-200/60 text-lg font-light tracking-wide max-w-md mx-auto">
                        Halo, {{ user_name.split(' ')[0] }}. Siap menjelajah?
                    </p>
                </div>
            </div>

            <!-- Chat Wrapper (Ini yang di-scroll) -->
            <div id="chat-wrapper" class="flex-1 overflow-y-auto w-full px-4 pt-24 pb-4 opacity-0 transition-all duration-500 scroll-smooth">
                <div id="messages-list" class="space-y-6 pb-4"></div>
                <!-- Spacer agar chat paling bawah tidak tertutup input -->
                <div class="h-32"></div>
            </div>
        </main>

        <!-- INPUT AREA (Fixed Bottom) -->
        <footer class="w-full bg-gradient-to-t from-black via-black/95 to-transparent pb-6 pt-10 px-4 z-20 absolute bottom-0">
            <div class="max-w-3xl mx-auto relative">
                <!-- Preview Image -->
                <div id="preview-box" class="hidden mb-3 ml-2 absolute -top-20 left-0 bg-[#0f172a] p-2 rounded-lg border border-blue-900/40 shadow-xl backdrop-blur-md">
                    <div class="relative inline-block group">
                        <img id="img-preview" src="" class="h-16 w-auto rounded border border-blue-900/50 object-cover">
                        <button onclick="removeImage()" class="absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs shadow transition-colors"><i class="fa-solid fa-times"></i></button>
                    </div>
                </div>
                
                <!-- Input Bar -->
                <div class="bg-[#0f172a]/80 backdrop-blur-md border border-blue-900/30 rounded-2xl flex items-end p-2 shadow-2xl focus-within:border-xanadium-blue/50 focus-within:ring-1 focus-within:ring-xanadium-blue/20 transition-all duration-300">
                    <button onclick="document.getElementById('file-input').click()" class="p-3 text-gray-400 hover:text-white hover:bg-white/10 rounded-xl transition-colors shrink-0 mx-1"><i class="fa-solid fa-paperclip text-lg"></i></button>
                    <input type="file" id="file-input" accept="image/*" class="hidden" onchange="handleFile(this)">
                    <textarea id="user-input" rows="1" class="w-full bg-transparent text-white border-none focus:ring-0 p-3 max-h-32 resize-none placeholder-gray-500 font-light text-base" placeholder="Kirim pesan..." oninput="autoResize(this)" onkeydown="handleEnter(event)"></textarea>
                    <button onclick="sendMessage()" id="send-btn" class="p-3 bg-white/5 hover:bg-xanadium-blue text-white rounded-xl transition-all shrink-0 ml-1 disabled:opacity-50 disabled:cursor-not-allowed"><i class="fa-solid fa-arrow-up"></i></button>
                </div>
                <div class="text-center mt-3"><p class="text-[10px] text-gray-600 font-medium tracking-widest uppercase">Powered by Xanadium Engine</p></div>
            </div>
        </footer>
    </div>

    <!-- Overlay Gelap (Saat Sidebar Buka) -->
    <div id="overlay" onclick="toggleSidebar()" class="fixed inset-0 z-40 hidden bg-black/50 backdrop-blur-sm transition-opacity duration-300"></div>

    <script>
        // --- KONFIGURASI HISTORY ---
        const STORAGE_KEY = 'xanadium_chat_v2';
        let currentSessionId = Date.now();
        let currentMessages = [];

        // DOM Elements
        const els = {
            sidebar: document.getElementById('main-sidebar'),
            overlay: document.getElementById('overlay'),
            welcome: document.getElementById('welcome-screen'),
            chatWrap: document.getElementById('chat-wrapper'),
            msgList: document.getElementById('messages-list'),
            brand: document.getElementById('brand-small'),
            input: document.getElementById('user-input'),
            sendBtn: document.getElementById('send-btn'),
            fileIn: document.getElementById('file-input'),
            previewBox: document.getElementById('preview-box'),
            imgPreview: document.getElementById('img-preview'),
            historyContainer: document.getElementById('history-list-container')
        };

        // --- SIDEBAR & UI LOGIC ---
        function toggleSidebar() {
            const isClosed = els.sidebar.classList.contains('-translate-x-full');
            if (isClosed) {
                // Buka
                loadHistoryToSidebar(); // Refresh history saat dibuka
                els.sidebar.classList.remove('-translate-x-full');
                els.overlay.classList.remove('hidden');
            } else {
                // Tutup
                els.sidebar.classList.add('-translate-x-full');
                els.overlay.classList.add('hidden');
            }
        }

        function scrollToBottom() {
            // Paksa scroll ke paling bawah
            setTimeout(() => {
                els.chatWrap.scrollTop = els.chatWrap.scrollHeight;
            }, 100);
        }

        function switchToChatUI() {
            // Sembunyikan welcome
            els.welcome.style.opacity = '0';
            setTimeout(() => els.welcome.classList.add('hidden-force'), 300);
            
            // Munculkan Chat
            els.chatWrap.classList.remove('opacity-0');
            els.brand.classList.remove('opacity-0', '-translate-y-5');
            els.brand.classList.add('translate-y-0');
        }

        function resetUI() {
            els.msgList.innerHTML = '';
            els.chatWrap.classList.add('opacity-0');
            els.welcome.classList.remove('hidden-force');
            setTimeout(() => els.welcome.style.opacity = '1', 50);
            els.brand.classList.add('opacity-0');
            els.input.value = '';
            removeImage();
        }

        // --- LOGIKA HISTORY OTOMATIS ---
        function saveSession() {
            if (currentMessages.length === 0) return;

            const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            
            // Judul otomatis dari pesan pertama user
            const firstMsg = currentMessages.find(m => m.isUser);
            const title = firstMsg ? (firstMsg.text.substring(0, 25) + '...') : 'Chat Baru';

            const sessionData = {
                id: currentSessionId,
                title: title,
                time: new Date().toLocaleString(),
                msgs: currentMessages
            };

            // Cek apakah update sesi lama atau buat baru
            const existingIndex = history.findIndex(h => h.id === currentSessionId);
            if (existingIndex > -1) {
                history[existingIndex] = sessionData;
            } else {
                history.unshift(sessionData); // Tambah di paling atas
            }

            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
            loadHistoryToSidebar(); // Update tampilan list real-time
        }

        function loadHistoryToSidebar() {
            const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            els.historyContainer.innerHTML = '';

            if (history.length === 0) {
                els.historyContainer.innerHTML = '<p class="text-center text-gray-600 text-xs mt-10 italic">Belum ada riwayat.</p>';
                return;
            }

            history.forEach(session => {
                const isActive = session.id === currentSessionId;
                const div = document.createElement('div');
                div.className = `p-3 rounded-lg cursor-pointer transition flex justify-between items-center group ${isActive ? 'bg-blue-600/20 border border-blue-500/30' : 'hover:bg-white/5 border border-transparent hover:border-white/10'}`;
                div.onclick = () => loadOldChat(session.id);
                
                div.innerHTML = `
                    <div class="overflow-hidden">
                        <h4 class="text-sm font-medium truncate ${isActive ? 'text-white' : 'text-gray-400 group-hover:text-gray-200'}">${session.title}</h4>
                        <p class="text-[10px] text-gray-600 truncate">${session.time}</p>
                    </div>
                    <button onclick="event.stopPropagation(); deleteChat(${session.id})" class="text-gray-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition px-2">
                        <i class="fa-solid fa-trash text-xs"></i>
                    </button>
                `;
                els.historyContainer.appendChild(div);
            });
        }

        function createNewChat() {
            currentSessionId = Date.now();
            currentMessages = [];
            resetUI();
            toggleSidebar(); // Tutup sidebar
        }

        function loadOldChat(id) {
            const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const session = history.find(h => h.id === id);
            if (session) {
                currentSessionId = session.id;
                currentMessages = session.msgs;
                
                resetUI();
                switchToChatUI();
                
                // Render ulang bubble chat
                currentMessages.forEach(msg => {
                    els.msgList.appendChild(createBubbleHTML(msg.isUser, msg.text, msg.img));
                });
                scrollToBottom();
                toggleSidebar();
            }
        }

        function deleteChat(id) {
            if(!confirm("Hapus percakapan ini?")) return;
            const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const newHistory = history.filter(h => h.id !== id);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(newHistory));
            
            if (id === currentSessionId) createNewChat();
            else loadHistoryToSidebar();
        }

        // --- MESSAGING SYSTEM ---
        
        function createBubbleHTML(isUser, text, imgUrl) {
            const div = document.createElement('div');
            div.className = `flex gap-4 ${isUser ? 'flex-row-reverse' : ''} animate-slide-up group mb-4`;
            
            const avatarUrl = isUser ? '{{ user_picture }}' : null;
            const avatar = isUser 
                ? `<img src="${avatarUrl}" onerror="this.src='https://ui-avatars.com/api/?background=random'" class="w-8 h-8 rounded-full border border-white/10 shrink-0">` 
                : `<div class="w-8 h-8 rounded-full bg-blue-900/30 flex items-center justify-center shrink-0 border border-blue-500/30 shadow-[0_0_10px_rgba(59,130,246,0.3)]"><span class="text-xanadium-blue font-bold text-sm">X</span></div>`;

            const imgTag = imgUrl ? `<img src="${imgUrl}" class="max-w-[250px] rounded-lg mb-2 border border-gray-700">` : '';
            const style = isUser 
                ? "bg-[#1e293b] border border-blue-900/40 text-gray-200 rounded-2xl rounded-tr-sm px-5 py-3" 
                : "text-gray-300 w-full prose prose-invert prose-p:text-gray-300 max-w-none pt-1";

            div.innerHTML = `
                ${avatar}
                <div class="flex flex-col max-w-[85%] ${isUser ? 'items-end' : 'items-start'}">
                    <div class="${style}">
                        ${imgTag}
                        <div class="msg-content leading-relaxed">${isUser ? text : marked.parse(text)}</div>
                    </div>
                </div>
            `;
            return div;
        }

        async function sendMessage() {
            const text = els.input.value.trim();
            if (!text && !els.fileIn.files[0]) return;
            
            els.sendBtn.disabled = true;
            switchToChatUI();

            // 1. Tampilkan Pesan User
            let imgSrc = els.imgPreview.src !== window.location.href ? els.imgPreview.src : null;
            els.msgList.appendChild(createBubbleHTML(true, text, imgSrc));
            scrollToBottom();

            // 2. Simpan ke Memory & LocalStorage (AUTO SAVE)
            currentMessages.push({ isUser: true, text: text, img: imgSrc });
            saveSession();

            // Prepare API Data
            const filePayload = els.fileIn.files[0];
            const formData = new FormData();
            formData.append('message', text);
            if (filePayload) formData.append('file', filePayload);

            // Reset Input
            els.input.value = '';
            els.input.style.height = 'auto';
            removeImage();

            // 3. Loading Animation
            const loadId = 'loading-' + Date.now();
            const loader = document.createElement('div');
            loader.id = loadId;
            loader.innerHTML = `<div class="flex gap-4 mb-4"><div class="w-8 h-8 rounded-full bg-blue-900/30 flex items-center justify-center">...</div><div class="text-gray-500 text-sm flex items-center animate-pulse">Sedang berpikir...</div></div>`;
            els.msgList.appendChild(loader);
            scrollToBottom();

            try {
                // 4. Fetch API
                const res = await fetch('/chat', { method: 'POST', body: formData });
                const data = await res.json();
                
                document.getElementById(loadId).remove();
                
                // 5. Tampilkan Balasan Bot
                const botBubble = createBubbleHTML(false, "");
                els.msgList.appendChild(botBubble);
                
                // Typewriter Effect
                const contentDiv = botBubble.querySelector('.msg-content');
                const botText = data.response || "Maaf, error.";
                
                // Simpan balasan bot (AUTO SAVE)
                currentMessages.push({ isUser: false, text: botText, img: null });
                saveSession();

                // Animasi Ngetik
                contentDiv.classList.add('typing-cursor');
                const words = botText.split(" ");
                let temp = "";
                for(let i=0; i<words.length; i++) {
                    temp += words[i] + " ";
                    contentDiv.innerText = temp;
                    if(i%5===0) { await new Promise(r => setTimeout(r, 10)); scrollToBottom(); }
                }
                contentDiv.innerHTML = marked.parse(botText);
                contentDiv.classList.remove('typing-cursor');
                scrollToBottom();

            } catch (e) {
                document.getElementById(loadId)?.remove();
                els.msgList.appendChild(createBubbleHTML(false, "Koneksi terputus."));
            } finally {
                els.sendBtn.disabled = false;
                els.input.focus();
                scrollToBottom();
            }
        }

        // Utils
        function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }
        function handleEnter(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }
        function handleFile(input) { if (input.files[0]) { const r = new FileReader(); r.onload = e => { els.imgPreview.src = e.target.result; els.previewBox.classList.remove('hidden'); }; r.readAsDataURL(input.files[0]); } }
        function removeImage() { els.fileIn.value = ''; els.previewBox.classList.add('hidden'); els.imgPreview.src = ''; }
        
        // Load history on startup
        window.onload = loadHistoryToSidebar;
    </script>
</body>
</html>


