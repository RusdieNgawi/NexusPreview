<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XanadiumAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { xanadium: { blue: '#3b82f6', glow: '#60a5fa', dark: '#020617', darker: '#000000' } },
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out forwards', 'slide-up': 'slideUp 0.4s ease-out forwards' },
                    keyframes: { 
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #000000;
            background-image: radial-gradient(circle at 50% -20%, #172554 0%, #000000 70%);
            background-attachment: fixed;
            color: #e5e5e5;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #3b82f6; }
        
        .hidden-force { display: none !important; }
        
        /* Typography Markdown Standard */
        .prose p { margin-bottom: 0.8em; line-height: 1.7; }
        .prose strong { color: #fff; font-weight: 600; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 0.8em; }
        .prose ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 0.8em; }
        .prose a { color: #60a5fa; text-decoration: underline; }
        
        /* --- NEW CODE BLOCK STYLING (Inspired by Reference) --- */
        .code-wrapper {
            background: #020617; /* Very Dark Blue/Black */
            border: 1px solid #1e3a8a; /* Blue Border Accent */
            border-radius: 12px;
            margin: 1.5em 0;
            overflow: hidden;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        
        /* Header Baris Kode */
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            background: #0f172a; /* Slate 900 */
            border-bottom: 1px solid #1e3a8a;
            font-size: 0.8rem;
            color: #e2e8f0;
            user-select: none;
        }
        
        /* Area Isi Kode */
        .code-content {
            padding: 16px;
            overflow-x: auto;
            color: #e2e8f0;
            font-size: 0.9em;
            line-height: 1.6;
            background: #000000; /* Pure Black bg for code */
        }
        
        .code-content pre { margin: 0; padding: 0; background: transparent; }
        .code-content code { background: transparent !important; padding: 0; border: none; color: inherit; }

        /* Tombol di Header */
        .header-btn {
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .header-btn:hover { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border-color: #3b82f6; }
        
        /* Tombol Preview Spesial */
        .preview-btn {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.3);
            margin-right: 8px;
        }
        .preview-btn:hover {
            background: #3b82f6;
            color: white;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        /* Inline Code */
        .prose :not(pre) > code { 
            background: #1e293b; 
            padding: 2px 6px; 
            border-radius: 4px; 
            font-family: monospace; 
            color: #60a5fa; 
            font-size: 0.85em; 
            border: 1px solid #1e3a8a; 
        }

        /* Cursor Animasi Mengetik */
        .typing-cursor::after { 
            content: 'â–‹'; 
            display: inline-block; 
            animation: blink 1s step-end infinite; 
            color: #3b82f6; 
            margin-left: 2px;
            vertical-align: text-bottom;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* Preview Modal */
        #code-preview-modal {
            animation: fadeIn 0.2s ease-out;
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden selection:bg-xanadium-blue selection:text-white">

    <!-- 1. SIDEBAR KIRI -->
    <aside id="main-sidebar" class="fixed inset-y-0 left-0 w-72 bg-[#020617]/95 backdrop-blur-xl border-r border-blue-900/30 transform -translate-x-full transition-transform duration-300 z-50 flex flex-col shadow-2xl">
        <div class="p-4 border-b border-blue-900/20 flex justify-between items-center">
            <div class="flex items-center gap-2 font-bold text-lg">
                <span class="text-xanadium-blue">Xanadium</span> AI
            </div>
            <button onclick="toggleSidebar()" class="text-gray-500 hover:text-white transition p-2"><i class="fa-solid fa-xmark text-lg"></i></button>
        </div>
        <div class="p-4 pb-2">
            <button onclick="createNewChat()" class="w-full bg-xanadium-blue/10 hover:bg-xanadium-blue/20 text-blue-400 hover:text-white border border-blue-500/20 px-4 py-3 rounded-xl transition flex items-center gap-3 text-sm font-medium">
                <i class="fa-solid fa-plus"></i> Chat Baru
            </button>
        </div>
        <div class="px-4 py-2 text-[10px] uppercase tracking-widest text-gray-500 font-semibold mt-2">Riwayat Percakapan</div>
        <div id="history-list-container" class="flex-1 overflow-y-auto px-3 space-y-1 pb-4"></div>
        <div class="p-4 border-t border-blue-900/20 bg-[#0f172a]/50">
            <div class="flex items-center gap-3 mb-4">
                <img src="{{ user_picture }}" onerror="this.src='https://ui-avatars.com/api/?name={{ user_name }}&background=3b82f6&color=fff'" class="w-9 h-9 rounded-full border border-blue-500/30">
                <div class="overflow-hidden">
                    <p class="text-sm font-semibold text-white truncate">{{ user_name }}</p>
                    <p class="text-[10px] text-gray-400 truncate">{{ user_email }}</p>
                </div>
            </div>
            <a href="/logout" class="block w-full text-center py-2 text-xs text-red-400 hover:text-red-300 hover:bg-red-500/10 rounded-lg transition border border-transparent hover:border-red-500/20">
                <i class="fa-solid fa-right-from-bracket mr-2"></i> Keluar Akun
            </a>
        </div>
    </aside>

    <!-- 2. MAIN CONTENT -->
    <div class="flex-1 flex flex-col h-full relative w-full transition-all duration-300">
        
        <!-- Navbar -->
        <nav class="absolute top-0 w-full p-4 md:p-6 flex items-center z-30 pointer-events-none">
            <button onclick="toggleSidebar()" class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-gray-300 hover:text-white transition backdrop-blur-md border border-white/5 pointer-events-auto">
                <i class="fa-solid fa-bars text-lg"></i>
            </button>
            <div id="brand-small" class="ml-4 opacity-0 transition-all duration-700 transform -translate-y-5 font-bold tracking-wide text-lg">
                <span class="text-xanadium-blue drop-shadow-[0_0_15px_rgba(59,130,246,0.6)]">Xanadium</span> AI
            </div>
        </nav>

        <!-- Chat Area -->
        <main class="flex-1 relative w-full max-w-4xl mx-auto h-full overflow-hidden flex flex-col">
            <div id="welcome-screen" class="absolute inset-0 flex flex-col items-center justify-center transition-all duration-700 z-20 px-4">
                <div class="text-center space-y-4 animate-fade-in">
                    <h1 class="text-5xl md:text-8xl font-bold tracking-tight">
                        <span class="text-xanadium-blue drop-shadow-[0_0_30px_rgba(59,130,246,0.5)]">Xanadium</span> 
                        <span class="text-white drop-shadow-[0_0_15px_rgba(255,255,255,0.3)]">AI</span>
                    </h1>
                    <p class="text-blue-200/60 text-lg font-light tracking-wide max-w-md mx-auto">
                        Halo, {{ user_name.split(' ')[0] }}. Siap menjelajah?
                    </p>
                </div>
            </div>

            <div id="chat-wrapper" class="flex-1 overflow-y-auto w-full px-4 pt-24 pb-4 opacity-0 transition-all duration-500 scroll-smooth">
                <div id="messages-list" class="space-y-6 pb-4"></div>
                <div class="h-32"></div> <!-- Spacer bottom -->
            </div>
        </main>

        <!-- Input Area -->
        <footer class="w-full bg-gradient-to-t from-black via-black/95 to-transparent pb-6 pt-10 px-4 z-20 absolute bottom-0">
            <div class="max-w-3xl mx-auto relative">
                <!-- File/Image Preview -->
                <div id="preview-box" class="hidden mb-3 ml-2 absolute -top-20 left-0 bg-[#0f172a] p-3 rounded-lg border border-blue-900/40 shadow-xl backdrop-blur-md flex items-center gap-3">
                    <img id="img-preview" src="" class="h-12 w-auto rounded border border-blue-900/50 object-cover hidden">
                    <div id="file-icon-preview" class="h-12 w-12 rounded bg-blue-900/30 flex items-center justify-center text-blue-400 text-xl border border-blue-900/50 hidden">
                        <i class="fa-solid fa-file-code"></i>
                    </div>
                    <div class="flex flex-col">
                        <span id="file-name-display" class="text-xs text-gray-300 font-mono truncate max-w-[150px]">filename.py</span>
                        <span class="text-[10px] text-gray-500">Siap diunggah</span>
                    </div>
                    <button onclick="removeFile()" class="text-red-400 hover:text-red-300 ml-2"><i class="fa-solid fa-times"></i></button>
                </div>
                
                <div class="bg-[#0f172a]/80 backdrop-blur-md border border-blue-900/30 rounded-2xl flex items-end p-2 shadow-2xl focus-within:border-xanadium-blue/50 focus-within:ring-1 focus-within:ring-xanadium-blue/20 transition-all duration-300">
                    <button onclick="document.getElementById('file-input').click()" class="p-3 text-gray-400 hover:text-white hover:bg-white/10 rounded-xl transition-colors shrink-0 mx-1" title="Upload Gambar atau File"><i class="fa-solid fa-paperclip text-lg"></i></button>
                    <input type="file" id="file-input" class="hidden" onchange="handleFile(this)">
                    <textarea id="user-input" rows="1" class="w-full bg-transparent text-white border-none focus:ring-0 p-3 max-h-32 resize-none placeholder-gray-500 font-light text-base" placeholder="Kirim pesan atau kode..." oninput="autoResize(this)" onkeydown="handleEnter(event)"></textarea>
                    <button onclick="sendMessage()" id="send-btn" class="p-3 bg-white/5 hover:bg-xanadium-blue text-white rounded-xl transition-all shrink-0 ml-1 disabled:opacity-50 disabled:cursor-not-allowed"><i class="fa-solid fa-arrow-up"></i></button>
                </div>
                <div class="text-center mt-3"><p class="text-[10px] text-gray-600 font-medium tracking-widest uppercase">Powered by Xanadium Engine</p></div>
            </div>
        </footer>
    </div>

    <!-- MODAL PREVIEW HTML (BARU) -->
    <div id="code-preview-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-[#0f172a] w-full max-w-5xl h-[85vh] rounded-xl border border-blue-900/50 flex flex-col shadow-2xl overflow-hidden relative">
            <!-- Header Modal -->
            <div class="p-3 bg-[#1e293b] border-b border-blue-900/30 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-3 h-3 rounded-full bg-red-500"></div>
                    <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                    <div class="w-3 h-3 rounded-full bg-green-500"></div>
                    <span class="text-gray-400 text-xs ml-2 font-mono">Xanadium Browser Preview</span>
                </div>
                <button onclick="closePreview()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <!-- Iframe Content -->
            <iframe id="preview-frame" class="w-full flex-1 bg-white" sandbox="allow-scripts"></iframe>
        </div>
    </div>

    <!-- Overlay Sidebar -->
    <div id="overlay" onclick="toggleSidebar()" class="fixed inset-0 z-40 hidden bg-black/50 backdrop-blur-sm transition-opacity duration-300"></div>

    <script>
        // ==========================================
        // 1. KONFIGURASI MARKED & PREVIEW FEATURE
        // ==========================================
        
        const renderer = new marked.Renderer();
        
        renderer.code = function(code, language) {
            const validLang = (language || 'text').toUpperCase();
            
            // Deteksi jika ini adalah HTML/XML untuk menampilkan tombol Preview
            const isHtml = validLang === 'HTML' || validLang === 'XML';
            
            const escapedCode = code.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
            const id = 'code-' + Math.random().toString(36).substr(2, 9);
            
            // Tombol Preview (Hanya untuk HTML)
            let previewButtonHtml = '';
            if (isHtml) {
                previewButtonHtml = `
                <button class="header-btn preview-btn" onclick="showPreview('${id}')">
                    <i class="fa-solid fa-play"></i> Preview
                </button>`;
            }

            return `
            <div class="code-wrapper group">
                <div class="code-header">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-code text-blue-500"></i>
                        <span class="font-bold tracking-wider text-gray-300">${validLang}</span>
                    </div>
                    <div class="flex items-center">
                        ${previewButtonHtml}
                        <button class="header-btn" onclick="copyCode(this, \`${id}\`)">
                            <i class="fa-regular fa-copy"></i> Salin
                        </button>
                    </div>
                </div>
                <div class="code-content">
                    <pre><code id="${id}" class="language-${language}">${escapedCode}</code></pre>
                </div>
            </div>`;
        };
        
        marked.use({ renderer });

        // Fungsi Salin
        function copyCode(btn, elementId) {
            const codeText = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(codeText).then(() => {
                const originalHtml = btn.innerHTML;
                btn.innerHTML = `<i class="fa-solid fa-check text-green-400"></i> Disalin!`;
                setTimeout(() => { btn.innerHTML = originalHtml; }, 2000);
            });
        }

        // Fungsi Preview
        function showPreview(elementId) {
            const code = document.getElementById(elementId).textContent;
            const modal = document.getElementById('code-preview-modal');
            const frame = document.getElementById('preview-frame');
            
            // Inject kode ke iframe
            frame.srcdoc = code;
            
            modal.classList.remove('hidden');
        }

        function closePreview() {
            const modal = document.getElementById('code-preview-modal');
            const frame = document.getElementById('preview-frame');
            modal.classList.add('hidden');
            frame.srcdoc = ''; // Clear iframe
        }

        // ==========================================
        // 2. LOGIKA UTAMA (SAMA SEPERTI SEBELUMNYA)
        // ==========================================

        const STORAGE_KEY = 'xanadium_chat_v3';
        let currentSessionId = Date.now();
        let currentMessages = [];

        const els = {
            sidebar: document.getElementById('main-sidebar'),
            overlay: document.getElementById('overlay'),
            welcome: document.getElementById('welcome-screen'),
            chatWrap: document.getElementById('chat-wrapper'),
            msgList: document.getElementById('messages-list'),
            brand: document.getElementById('brand-small'),
            input: document.getElementById('user-input'),
            sendBtn: document.getElementById('send-btn'),
            fileIn: document.getElementById('file-input'),
            previewBox: document.getElementById('preview-box'),
            imgPreview: document.getElementById('img-preview'),
            fileIconPreview: document.getElementById('file-icon-preview'),
            fileNameDisplay: document.getElementById('file-name-display'),
            historyContainer: document.getElementById('history-list-container')
        };

        // --- UI LOGIC ---
        function toggleSidebar() {
            const isClosed = els.sidebar.classList.contains('-translate-x-full');
            if (isClosed) { loadHistoryToSidebar(); els.sidebar.classList.remove('-translate-x-full'); els.overlay.classList.remove('hidden'); } 
            else { els.sidebar.classList.add('-translate-x-full'); els.overlay.classList.add('hidden'); }
        }

        function scrollToBottom() { els.chatWrap.scrollTo({ top: els.chatWrap.scrollHeight, behavior: 'smooth' }); }

        function switchToChatUI() {
            els.welcome.style.opacity = '0'; setTimeout(() => els.welcome.classList.add('hidden-force'), 300);
            els.chatWrap.classList.remove('opacity-0'); els.brand.classList.remove('opacity-0', '-translate-y-5'); els.brand.classList.add('translate-y-0');
        }

        function resetUI() {
            els.msgList.innerHTML = ''; els.chatWrap.classList.add('opacity-0');
            els.welcome.classList.remove('hidden-force'); setTimeout(() => els.welcome.style.opacity = '1', 50);
            els.brand.classList.add('opacity-0'); els.input.value = ''; removeFile();
        }

        // --- CORE MESSAGING ---
        function createBubbleHTML(isUser, text, attachment) {
            const div = document.createElement('div');
            div.className = `flex gap-4 ${isUser ? 'flex-row-reverse' : ''} animate-slide-up group mb-4 w-full`;
            const avatar = isUser ? `<img src="{{ user_picture }}" onerror="this.src='https://ui-avatars.com/api/?name={{ user_name }}'" class="w-8 h-8 rounded-full border border-white/10 shrink-0 mt-1">` : `<div class="w-8 h-8 rounded-full bg-blue-900/30 flex items-center justify-center shrink-0 border border-blue-500/30 shadow-[0_0_10px_rgba(59,130,246,0.3)] mt-1"><span class="text-xanadium-blue font-bold text-sm">X</span></div>`;

            let attachmentHtml = '';
            if (attachment) {
                if (attachment.type === 'image') attachmentHtml = `<img src="${attachment.data}" class="max-w-[250px] rounded-lg mb-2 border border-gray-700 block">`;
                else if (attachment.type === 'file') attachmentHtml = `<div class="flex items-center gap-3 bg-gray-800/50 p-3 rounded-lg border border-gray-700 mb-2 max-w-[250px]"><i class="fa-solid fa-file-lines text-blue-400 text-lg"></i><div class="overflow-hidden"><p class="text-xs text-white font-mono truncate">${attachment.name}</p></div></div>`;
            }

            const style = isUser ? "bg-[#1e293b] border border-blue-900/40 text-gray-200 rounded-2xl rounded-tr-sm px-5 py-3 text-sm" : "text-gray-300 w-full max-w-none pt-1 prose prose-invert";
            div.innerHTML = `${avatar}<div class="flex flex-col max-w-[85%] ${isUser ? 'items-end' : 'items-start'} min-w-0"><div class="${style}">${attachmentHtml}<div class="msg-content leading-relaxed min-w-0 break-words">${isUser ? text.replace(/\n/g, '<br>') : ''}</div></div></div>`;
            return div;
        }

        async function sendMessage() {
            const text = els.input.value.trim();
            if (!text && !currentFile) return;
            els.sendBtn.disabled = true; switchToChatUI();

            let attachmentData = null;
            if (currentFile) attachmentData = { type: currentFile.type.startsWith('image/') ? 'image' : 'file', data: els.imgPreview.src, name: currentFile.name };

            els.msgList.appendChild(createBubbleHTML(true, text, attachmentData));
            scrollToBottom();
            currentMessages.push({ isUser: true, text: text, attachment: attachmentData });
            saveSession();

            const formData = new FormData();
            formData.append('message', text);
            if (els.fileIn.files[0]) formData.append('file', els.fileIn.files[0]);

            els.input.value = ''; els.input.style.height = 'auto'; removeFile();

            const loadId = 'loading-' + Date.now();
            const loader = document.createElement('div');
            loader.id = loadId; loader.innerHTML = `<div class="flex gap-4 mb-4 ml-12"><div class="text-gray-500 text-sm flex items-center gap-2"><span class="w-2 h-2 bg-blue-500 rounded-full animate-ping"></span> Mengetik...</div></div>`;
            els.msgList.appendChild(loader); scrollToBottom();

            try {
                const res = await fetch('/chat', { method: 'POST', body: formData });
                const data = await res.json();
                document.getElementById(loadId).remove();
                
                const botBubble = createBubbleHTML(false, "");
                els.msgList.appendChild(botBubble);
                const contentDiv = botBubble.querySelector('.msg-content');
                const botText = data.response || "Error.";
                currentMessages.push({ isUser: false, text: botText, attachment: null });
                saveSession();

                // Typing Effect
                contentDiv.classList.add('typing-cursor');
                const chars = botText.split(""); 
                let tempRaw = "";
                for (let i = 0; i < chars.length; i++) {
                    tempRaw += chars[i]; contentDiv.textContent = tempRaw; 
                    if (i % 20 === 0) scrollToBottom(); await new Promise(r => setTimeout(r, 6));
                }
                contentDiv.innerHTML = marked.parse(botText);
                contentDiv.classList.remove('typing-cursor'); scrollToBottom();

            } catch (e) { document.getElementById(loadId)?.remove(); els.msgList.appendChild(createBubbleHTML(false, "Koneksi terputus.")); } 
            finally { els.sendBtn.disabled = false; els.input.focus(); scrollToBottom(); }
        }

        // --- FILE HANDLING ---
        let currentFile = null;
        function handleFile(input) {
            if (input.files[0]) {
                currentFile = input.files[0]; els.fileNameDisplay.innerText = currentFile.name; els.previewBox.classList.remove('hidden');
                if (currentFile.type.startsWith('image/')) {
                    const r = new FileReader(); r.onload = e => { els.imgPreview.src = e.target.result; els.imgPreview.classList.remove('hidden'); els.fileIconPreview.classList.add('hidden'); }; r.readAsDataURL(currentFile);
                } else { els.imgPreview.classList.add('hidden'); els.fileIconPreview.classList.remove('hidden'); }
            }
        }
        function removeFile() { els.fileIn.value = ''; currentFile = null; els.previewBox.classList.add('hidden'); els.imgPreview.src = ''; }

        // --- UTILS & HISTORY ---
        function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }
        function handleEnter(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }
        
        function saveSession() {
            if (currentMessages.length === 0) return;
            const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const firstMsg = currentMessages.find(m => m.isUser);
            const title = firstMsg ? (firstMsg.text.substring(0, 30) + '...') : 'Chat Baru';
            const data = { id: currentSessionId, title: title, time: new Date().toLocaleString(), msgs: currentMessages };
            const idx = history.findIndex(h => h.id === currentSessionId);
            if (idx > -1) history[idx] = data; else history.unshift(data);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history)); loadHistoryToSidebar();
        }

        function loadHistoryToSidebar() {
            const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            els.historyContainer.innerHTML = history.length === 0 ? '<p class="text-center text-gray-600 text-xs mt-10 italic">Belum ada riwayat.</p>' : '';
            history.forEach(s => {
                const isActive = s.id === currentSessionId;
                const div = document.createElement('div');
                div.className = `p-3 rounded-lg cursor-pointer transition flex justify-between items-center group ${isActive ? 'bg-blue-600/20 border border-blue-500/30' : 'hover:bg-white/5 border border-transparent hover:border-white/10'}`;
                div.onclick = () => loadOldChat(s.id);
                div.innerHTML = `<div class="overflow-hidden"><h4 class="text-sm font-medium truncate ${isActive?'text-white':'text-gray-400'}">${s.title}</h4><p class="text-[10px] text-gray-600">${s.time}</p></div><button onclick="event.stopPropagation(); deleteChat(${s.id})" class="text-gray-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition px-2"><i class="fa-solid fa-trash text-xs"></i></button>`;
                els.historyContainer.appendChild(div);
            });
        }

        function createNewChat() { currentSessionId = Date.now(); currentMessages = []; resetUI(); toggleSidebar(); }
        function loadOldChat(id) {
            const s = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]').find(h => h.id === id);
            if (s) { currentSessionId = s.id; currentMessages = s.msgs; resetUI(); switchToChatUI(); currentMessages.forEach(msg => { const b = createBubbleHTML(msg.isUser, msg.text, msg.attachment); els.msgList.appendChild(b); if(!msg.isUser) b.querySelector('.msg-content').innerHTML = marked.parse(msg.text); }); scrollToBottom(); toggleSidebar(); }
        }
        function deleteChat(id) { if(confirm("Hapus?")) { const h=JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); localStorage.setItem(STORAGE_KEY, JSON.stringify(h.filter(x=>x.id!==id))); if(id===currentSessionId) createNewChat(); else loadHistoryToSidebar(); } }

        window.onload = loadHistoryToSidebar;
    </script>
</body>
</html>


